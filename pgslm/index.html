<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Expressive speech modeling and generation</title>
        <link rel="stylesheet" type="text/css" href="styles.css">
        <script src="jquery-3.5.js"></script>
    </head>
    <body>
<div class="container">
    <div id="text1">Text-Free Prosody-Aware Generative Spoken Language Modeling</div>
    <div id="intro">
        <br>
      <p>
      Eugene Kharitonov*, Ann Lee*, Adam Polyak, Yossi Adi, Jade Copet, Kushal Lakhotia, Tu-Anh Nguyen, <br> Morgane Rivière, Abdelrahman Mohamed, Emmanuel Dupoux, Wei-Ning Hsu
        </p>
    </div>
</div>
<div class="content-container">
    <img src="figure.png" style="width:40%">
    <p>
  Previous generative spoken language modeling work have used discrete units
  that discard most of the prosodic information, failing to leverage
  prosody for better comprehension and generation. 
  We  introduce  a  prosody-aware  generative  spoken language model
  (pGSLM). It is composed of a multi-stream transformer language
  model (MS-TLM)  of  speech,  represented  as  discovered  unit  and
  prosodic  feature  streams,  and an adapted HiFi-GAN model
  converting MS-TLM outputs to waveforms. Experimental results show that
  the  pGSLM  can  utilize  prosody  to improve both prosody and
  content modeling, and also generate more natural,  meaningful,  and coherent speech given a spoken prompt.
  </br>
  </br>

  * equal contribution
    </p>
    <br/>
</div>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">


<div class="content-container">
    <script src="wavesurfer.js"></script>
<div class="content-title">Conditional Speech Generation Examples</div>
<p style="margin-bottom: 1cm;">In conditional generation, the system encodes a waveform prompt into a sequence of tuples of pseudo-text units, normalized F0, and duration.
   This sequence is then fed to the multi-stream language model (MS-TLM) from which a continuation is sampled in an auto-regressive manner.
   The result is then passed to the decoder to produce a new waveform.  The entire pipeline is trained without supervision or text. 
   Below are prompts, ground-truth continuations (resynthesised), and samples from our models.</p>
   <div id='legend-teaser'>
    <ul style="list-style-type:none;font-size:80%">
  <li>✅: model has prosody (unit duration and F0) as a part of its input</li>
  <li>❌: model has no prosody in its input</li>
      </ul>    
  </div>

    <table border = "1" class="inlineTable" >
        <!-- <col width="30">
        <col width="300">
        <col width="300">
        <col width="300">
        <col width="300">
        <col width="300">
        <col width="300">
        <col width="300"> -->
        <tr>
            <td>Prompt</td>
            <td>Resynthesis</td>
            <td colspan="2">Continuous Prosody</td>
            <td colspan="2">Quantized Prosody</td>
        </tr>
        <tr>
            <th></th>
            <th></th>
            <th>❌</th>
            <th>✅</th>
            <th>❌</th>
            <th>✅</th>
        </tr>
        <tr>
            <td>
                <div id="prompts_1_header_waveform"></div>
                <button id="prompts_1_header" class="play-button-demo btn btn-primary" onclick="wavesurfer_prompts_1.playPause()">
                    <i class="fa fa-play"></i>
                    Play
                    /
                    <i class="fa fa-pause"></i>
                    Pause
                </button>
                <script>
                    var wavesurfer_prompts_1 = WaveSurfer.create({
                                container: '#prompts_1_header_waveform',
                                waveColor: 'violet',
                                progressColor: 'purple'
                            });
                    wavesurfer_prompts_1.load('./audio/speech_cont/librispeech/prompts/4.wav');
                </script>
           </td>
            <td>
                <div id="method5_1_header_waveform"></div>
                <button id="method5_1_header" class="play-button-demo btn btn-primary" onclick="wavesurfer_method5_1.playPause()">
                    <i class="fa fa-play"></i>
                    Play
                    /
                    <i class="fa fa-pause"></i>
                    Pause
                </button>
                <script>
                    var wavesurfer_method5_1 = WaveSurfer.create({
                                container: '#method5_1_header_waveform',
                                waveColor: 'violet',
                                progressColor: 'purple'
                            });
                    wavesurfer_method5_1.load('./audio/speech_cont/librispeech/method5/4.wav')
                </script>
           </td>
            <td>
                <div id="method1_1_header_waveform"></div>
                <button id="method1_1_header" class="play-button-demo btn btn-primary" onclick="wavesurfer_method1_1.playPause()">
                    <i class="fa fa-play"></i>
                    Play
                    /
                    <i class="fa fa-pause"></i>
                    Pause
                </button>
                <script>
                    var wavesurfer_method1_1 = WaveSurfer.create({
                                container: '#method1_1_header_waveform',
                                waveColor: 'violet',
                                progressColor: 'purple'
                            });
                    wavesurfer_method1_1.load('./audio/speech_cont/librispeech/method1/4.wav')
                </script>
           </td>
            <td>
                <div id="method2_1_header_waveform"></div>
                <button id="method2_1_header" class="play-button-demo btn btn-primary" onclick="wavesurfer_method2_1.playPause()">
                    <i class="fa fa-play"></i>
                    Play
                    /
                    <i class="fa fa-pause"></i>
                    Pause
                </button>
                <script>
                    var wavesurfer_method2_1 = WaveSurfer.create({
                                container: '#method2_1_header_waveform',
                                waveColor: 'violet',
                                progressColor: 'purple'
                            });
                    wavesurfer_method2_1.load('./audio/speech_cont/librispeech/method2/4.wav');
                </script>
           </td>
           <td>
            <div id="method4_1_header_waveform"></div>
            <button id="method4_1_header" class="play-button-demo btn btn-primary" onclick="wavesurfer_method4_1.playPause()">
                <i class="fa fa-play"></i>
                Play
                /
                <i class="fa fa-pause"></i>
                Pause
            </button>
            <script>
                var wavesurfer_method4_1 = WaveSurfer.create({
                            container: '#method4_1_header_waveform',
                            waveColor: 'violet',
                            progressColor: 'purple'
                        });
                wavesurfer_method4_1.load('./audio/speech_cont/librispeech/method4/4.wav');
            </script>
            </td>
            <td>
                <div id="method3_1_header_waveform"></div>
                <button id="method3_1_header" class="play-button-demo btn btn-primary" onclick="wavesurfer_method3_1.playPause()">
                    <i class="fa fa-play"></i>
                    Play
                    /
                    <i class="fa fa-pause"></i>
                    Pause
                </button>
                <script>
                    var wavesurfer_method3_1 = WaveSurfer.create({
                                container: '#method3_1_header_waveform',
                                waveColor: 'violet',
                                progressColor: 'purple'
                            });
                    wavesurfer_method3_1.load('./audio/speech_cont/librispeech/method3/4.wav');
                </script>
                </td>

        </tr>
        <tr>
            <td>
                <div id="prompts_2_header_waveform"></div>
                <button id="prompts_2_header" class="play-button-demo btn btn-primary" onclick="wavesurfer_prompts_2.playPause()">
                    <i class="fa fa-play"></i>
                    Play
                    /
                    <i class="fa fa-pause"></i>
                    Pause
                </button>
                <script>
                    var wavesurfer_prompts_2 = WaveSurfer.create({
                                container: '#prompts_2_header_waveform',
                                waveColor: 'violet',
                                progressColor: 'purple'
                            });
                    wavesurfer_prompts_2.load('./audio/speech_cont/librispeech/prompts/5.wav');
                </script>
           </td>
            <td>
                <div id="method5_2_header_waveform"></div>
                <button id="method5_2_header" class="play-button-demo btn btn-primary" onclick="wavesurfer_method5_2.playPause()">
                    <i class="fa fa-play"></i>
                    Play
                    /
                    <i class="fa fa-pause"></i>
                    Pause
                </button>
                <script>
                    var wavesurfer_method5_2 = WaveSurfer.create({
                                container: '#method5_2_header_waveform',
                                waveColor: 'violet',
                                progressColor: 'purple'
                            });
                    wavesurfer_method5_2.load('./audio/speech_cont/librispeech/method5/5.wav')
                </script>
           </td>
            <td>
                <div id="method1_2_header_waveform"></div>
                <button id="method1_2_header" class="play-button-demo btn btn-primary" onclick="wavesurfer_method1_2.playPause()">
                    <i class="fa fa-play"></i>
                    Play
                    /
                    <i class="fa fa-pause"></i>
                    Pause
                </button>
                <script>
                    var wavesurfer_method1_2 = WaveSurfer.create({
                                container: '#method1_2_header_waveform',
                                waveColor: 'violet',
                                progressColor: 'purple'
                            });
                    wavesurfer_method1_2.load('./audio/speech_cont/librispeech/method1/5.wav')
                </script>
           </td>
            <td>
                <div id="method2_2_header_waveform"></div>
                <button id="method2_2_header" class="play-button-demo btn btn-primary" onclick="wavesurfer_method2_2.playPause()">
                    <i class="fa fa-play"></i>
                    Play
                    /
                    <i class="fa fa-pause"></i>
                    Pause
                </button>
                <script>
                    var wavesurfer_method2_2 = WaveSurfer.create({
                                container: '#method2_2_header_waveform',
                                waveColor: 'violet',
                                progressColor: 'purple'
                            });
                    wavesurfer_method2_2.load('./audio/speech_cont/librispeech/method2/5.wav');
                </script>
           </td>
           <td>
            <div id="method4_2_header_waveform"></div>
            <button id="method4_2_header" class="play-button-demo btn btn-primary" onclick="wavesurfer_method4_2.playPause()">
                <i class="fa fa-play"></i>
                Play
                /
                <i class="fa fa-pause"></i>
                Pause
            </button>
            <script>
                var wavesurfer_method4_2 = WaveSurfer.create({
                            container: '#method4_2_header_waveform',
                            waveColor: 'violet',
                            progressColor: 'purple'
                        });
                wavesurfer_method4_2.load('./audio/speech_cont/librispeech/method4/5.wav');
            </script>
            </td>
            <td>
                <div id="method3_2_header_waveform"></div>
                <button id="method3_2_header" class="play-button-demo btn btn-primary" onclick="wavesurfer_method3_2.playPause()">
                    <i class="fa fa-play"></i>
                    Play
                    /
                    <i class="fa fa-pause"></i>
                    Pause
                </button>
                <script>
                    var wavesurfer_method3_2 = WaveSurfer.create({
                                container: '#method3_2_header_waveform',
                                waveColor: 'violet',
                                progressColor: 'purple'
                            });
                    wavesurfer_method3_2.load('./audio/speech_cont/librispeech/method3/5.wav');
                </script>
                </td>

        </tr>
        <!--
        <tr>
            <th>1</th>
            <td>
                <div id="prompts_2_header_waveform"></div>
                <button id="prompts_2_header" class="play-button-demo btn btn-primary" onclick="wavesurfer_prompts_2.playPause()">
                    <i class="fa fa-play"></i>
                    Play
                    /
                    <i class="fa fa-pause"></i>
                    Pause
                </button>
                <script>
                    var wavesurfer_prompts_2 = WaveSurfer.create({
                                container: '#prompts_2_header_waveform',
                                waveColor: 'violet',
                                progressColor: 'purple'
                            });
                    wavesurfer_prompts_2.load('./audio/prompts/8463-294825-0001__0.wav');
                </script>
           </td>
            <td>
                <div id="logmel_2_header_waveform"></div>
                <button id="logmel_2_header" class="play-button-demo btn btn-primary" onclick="wavesurfer_logmel_2.playPause()">
                    <i class="fa fa-play"></i>
                    Play
                    /
                    <i class="fa fa-pause"></i>
                    Pause
                </button>
                <script>
                    var wavesurfer_logmel_2 = WaveSurfer.create({
                                container: '#logmel_2_header_waveform',
                                waveColor: 'violet',
                                progressColor: 'purple'
                            });
                    wavesurfer_logmel_2.load('./audio/logmel/cond/8463-294825-0001__0.wav');
                </script>
           </td>
            <td>
                <div id="hubert_2_header_waveform"></div>
                <button id="hubert_2_header" class="play-button-demo btn btn-primary" onclick="wavesurfer_hubert_2.playPause()">
                    <i class="fa fa-play"></i>
                    Play
                    /
                    <i class="fa fa-pause"></i>
                    Pause
                </button>
                <script>
                    var wavesurfer_hubert_2 = WaveSurfer.create({
                                container: '#hubert_2_header_waveform',
                                waveColor: 'violet',
                                progressColor: 'purple'
                            });
                    wavesurfer_hubert_2.load('./audio/hubert/cond/8463-294825-0001__0.wav');
                </script>
           </td>
            <td>
                <div id="asr_2_header_waveform"></div>
                <button id="asr_2_header" class="play-button-demo btn btn-primary" onclick="wavesurfer_asr_2.playPause()">
                    <i class="fa fa-play"></i>
                    Play
                    /
                    <i class="fa fa-pause"></i>
                    Pause
                </button>
                <script>
                    var wavesurfer_asr_2 = WaveSurfer.create({
                                container: '#asr_2_header_waveform',
                                waveColor: 'violet',
                                progressColor: 'purple'
                            });
                    wavesurfer_asr_2.load('./audio/asr/cond/8463-294825-0001__0.wav');
                </script>
           </td>
        </tr>
        -->
    </table>
</div>

<div class="content-container">
    <div class="content-title">Samples</div>
    <div id='task-description' style="margin-bottom: 1cm;">
        In the first task, <i>speech generation</i>, MS-TLM models generate continuation of a speech prompt.
        In the second task, <i>prosody continuation</i>, the models generate prosody streams (duration and normalized F0), while 
        the stream of units is fixed to that of the ground-truth utterance. For comparison, we additionally provide original utterances
        as-is and resynthesised using the HiFi-GAN vocoder used by MS-TLM.
    </div>
    <div class="option-div">
    <label for="dataset">Choose a dataset:</label>
    <select id="dataset" onchange=record(this)>
        <option value=librispeech>LibriSpeech</option>
        <option value=blizzard>Blizzard</option>
    </select></div>
    <div class="option-div" id="tasks-div">
        <label for="tasks">Choose task:</label>
        <select id="tasks" onchange=record(this)>
            <option value="speech_cont">Speech continuation</option>
            <option value="prosody_cont">Prosody continuation</option>
            <!-- <option value="prosody_cont">Prosody continuation</option> -->
        </select>
    </div>
    <div id='legend'>
      <ul style="list-style-type:none;font-size:80%">
	<li>✅: model has prosody (unit duration and F0) as a part of its input</li>
	<li>❌: model has no prosody in its input</li>
        </ul>    
    </div>
    <div id="result-div"></div>
    
    </div>

<div id="loading-status">Loading......</div>

<script>
        var mode = 0;
        var audio;
        var filename = null;
        function play(file_name) {
            if (filename !== file_name) {
                if (audio) {
                    audio.pause();
                }

                audio = new Audio(file_name);
                filename = file_name;
                audio.play();
            } else {
                if (audio.paused ) {
                    audio = new Audio(file_name);
                    filename = file_name;
                    audio.play();
                } else {
                    audio.pause();
                }
            }
        }
        function switchMode() {
            if (document.getElementById("myonoffswitch").checked) {
                mode = 0;
            }
            else {
                mode = 1;
            }
        }
    </script>

<script>
        /* Highlights the navigation bar button corresponding to page
        to indicate which page a user is currently viewing.
        */
        var tasks="speech_cont";
        var dataset="librispeech";

        var methods = [
            "prompts",
            "oracle",
            "method5",
            "method1",
            "method2",
            "method4",
            "method3",
        ];

        var method_to_hdr = {
            "method1": "-Q-P" , /*no-quant, w/o prosody input */
            "method2": "-Q+P", /* no-quant, w/ prosody input */
            "method3": "+Q+P (proposed)",  /* quant, w/ prosody input (proposed) */
            "method4": "+Q-P", /* quant, w/o prosody input */ 
            "method5": "Resynth",
            "oracle": "Original",
            "prompt": "Prompt",
        };

        var task_to_hdr = {
            "speech_cont": "Speech cont.",
            "prosody_cont": "Prosody cont.",
        };
      
        var root = 'https://dl.fbaipublicfiles.com/textless_nlp/pgslm/demo';

        function lock(){
            $('#dataset').attr('disabled', 'disabled');
            $('#tasks').attr('disabled', 'disabled');
            $('#loading-status').show();
        }
        function unlock(){
            $('#dataset').removeAttr('disabled');
            $('#tasks').removeAttr('disabled');
            $('#loading-status').hide();
        }

        function preload(dataset, tasks, push){
            lock();
            $('#tasks').val(tasks);
            $("#result-div").empty();
            $("#result-div").append(createTable());
            if (false) { //tasks === 'voice_conversion' || tasks === 'resynthesis') {
                let footer = document.createElement('p');
                footer.append('* Additional 20 units used for pitch stream.');
                $("#result-div").append(footer);
            }
            unlock();
        }

        preload(dataset, tasks, true);

        function createTable() {
            var tableElem;
            tableElem = document.createElement('table');

            return buildContinuationTable(tableElem);
        }

        function buildContinuationTable(tableElem) {
             var headline, colElem, rowElem;

            headline = document.createElement('tr');

            var names = ["", "Prompt", "Original", "Resynth"];
            names.forEach((name) => {
                colElem = document.createElement('td');
                colElem.appendChild(document.createTextNode(name));
                colElem.style.color = 'rgb(22, 38, 67)';
                colElem.style.center = true;
                headline.appendChild(colElem);
            });

            var names = ["Continuous prosody", "Quantized prosody"];
            names.forEach((name) => {
                colElem = document.createElement('td');
                colElem.appendChild(document.createTextNode(name));
                colElem.style.color = 'rgb(22, 38, 67)';
                colElem.style.center = true;
                colElem.colSpan = 2;
                headline.appendChild(colElem);
            });

            tableElem.appendChild(headline);
            headline = document.createElement('tr');
            for (var _ = 0; _ < 4; ++_) {
                colElem = document.createElement('td');
                headline.appendChild(colElem);
            }

            for (var ii = 0; ii < 4; ++ii) {
                var hasProsodyInput = (ii % 2) == 1;
                var name = hasProsodyInput? "✅" : "❌";

                colElem = document.createElement('td');
                colElem.appendChild(document.createTextNode(name));
                colElem.style.color = 'rgb(22, 38, 67)';
                colElem.style.center = true;
                headline.appendChild(colElem);
            };

            
            /*
            colElem = document.createElement('td');
            colElem.appendChild(document.createTextNode('ID'));
            colElem.style.color = 'rgb(22, 38, 67)';
            colElem.style.center = true;
            headline.appendChild(colElem);

            colElem = document.createElement('td');
            colElem.appendChild(document.createTextNode('Prompt'));
            colElem.style.color = 'rgb(22, 38, 67)';
            colElem.style.center = true;
            headline.appendChild(colElem);

            for (var ii = 0; ii < methods.length; ii++) {
                colElem = document.createElement('td');
                colElem.appendChild(document.createTextNode(method_to_hdr[methods[ii]]));
                colElem.style.color = 'rgb(22, 38, 67)';
                colElem.style.center = true;
                colElem.style.whiteSpace = 'pre';
                headline.appendChild(colElem);
            }
            */

            tableElem.appendChild(headline);

            var bg_color='white';
            var txt_color='rgb(22, 38, 67)';

            var N = 100;
            for (var j = 0; j < N; j++) {
                rowElem = document.createElement('tr');
                rowElem.style.backgroundColor = bg_color;

                colElem = document.createElement('td');
                colElem.appendChild(document.createTextNode(j.toString()));
                colElem.style.color = txt_color;
                colElem.style.center = true;
                rowElem.appendChild(colElem);

                /*colElem = document.createElement('td');
                colElem.appendChild(document.createTextNode(task_to_hdr[tasks]));
                colElem.style.color = txt_color;
                colElem.style.center = true;
                rowElem.appendChild(colElem);*/

                for (var ii = 0; ii < methods.length; ii++) {
                    colElem = document.createElement('td');
                    var x = document.createElement("input");
                    x.setAttribute("type", "button");
                    x.setAttribute("value", "PLAY");
                    var audio_path = root + "/" + tasks + "/" + dataset + "/" + methods[ii] + "/" + j.toString() + ".wav";
                    x.setAttribute("onclick", "play('" + root + "/" + tasks + "/" + dataset + "/" + methods[ii] + "/" + j.toString() + ".wav')");
                    colElem.appendChild(x);
                    colElem.style.color = txt_color;
                    colElem.style.center = true;
                    rowElem.appendChild(colElem);
                }

                tableElem.appendChild(rowElem);

                if ((j+1) % 10 === 0) {
                    flip = bg_color
                    bg_color = txt_color;
                    txt_color = flip;
                }
            }

            return tableElem;
        }

        function fetch_result(){
            $(window).ready(function() {
                dataset=$("#dataset").val();
                tasks=$("#tasks").val();
                $("#result-div").empty();
                /*if (dataset === 'librispeech') {
                    $("#tasks").empty();
                    $("#tasks").append('<option value="resynthesis">Resynthesis</option>');
                    $("#tasks").append('<option value="voice_conversion">Voice Conversion</option>');
                    $("#tasks").val(tasks);
                } else {
                    $("#tasks").empty();
                    $("#tasks").append('<option value="resynthesis">Resynthesis</option>');
                    $("#tasks").append('<option value="voice_conversion">Voice Conversion</option>');
                    $("#tasks").append('<option value="codec">Codec (Unseen Speakers)</option>');
                    $("#tasks").val(tasks);
                }
                */

                $("#result-div").append(createTable());
                if (false) { //tasks === 'voice_conversion' || tasks === 'resynthesis') {
                    let footer = document.createElement('p');
                    footer.append('* Additional 20 units used for pitch stream.');
                    $("#result-div").append(footer);
                }
                unlock();
            });
            
        }

        function record(sel) {
            lock();
            fetch_result();
        }

        window.addEventListener('popstate', function(e) {
            preload(e.state["dataset"], e.state["tasks"], false);
        });
    </script>

<div class="content-container">
    Sample paged based on <a style="color:rgb(22, 38, 67)"  href="https://daps.cs.princeton.edu/projects/HiFi-GAN/index.php"> HiFi-GAN</a> page.  
</div>
</body>
</html>
